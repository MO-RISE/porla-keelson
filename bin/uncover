#!/usr/bin/env python3

"""
Command line utility tool for processing input from stdin. Each line on the
input stream is expected to be a serialized, base64-encoded brefv.Envelope.
The envelope will be deserialized and the payload will be base64-encoded and
outputted to stdout together with timestamps received_at and enclosed_at.
"""

import sys
from base64 import b64encode, b64decode

from brefv import uncover

for line in sys.stdin:
    message = b64decode(line.encode())
    received_at, enclosed_at, payload = uncover(message)
    sys.stdout.write(f"{received_at} {enclosed_at} {b64encode(payload).decode()}\n")
    sys.stdout.flush()
